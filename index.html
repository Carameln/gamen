<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>HIT & BLOW - Pixel Style</title>

  <!-- ドットフォント -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Press Start 2P', cursive;
      background: #111;
      color: #fff;
      text-align: center;
      padding: 20px;
      image-rendering: pixelated;
    }

    #container {
      max-width: 1000px;
      margin: auto;
      padding: 20px;
      border: 6px solid #fff;
      background: #000;
    }

    h1 {
      font-size: 22px;
      margin-bottom: 20px;
    }

    /* 上段：CPU LEVEL & YOUR NUMBER */
    .setup-row {
      display: flex;
      justify-content: space-between;
      gap: 20px;
    }

    .setup-box {
      width: 48%;
      background: #111;
      border: 4px solid #fff;
      padding: 15px;
      min-height: 200px;
    }

    .setup-box h2 {
      font-size: 16px;
      margin-bottom: 20px;
    }

    .fake-input {
      width: 200px;
      margin: 0 auto 10px;
      border: 4px solid #fff;
      background: #000;
      padding: 10px;
    }

    select {
      width: 100%;
      font-family: 'Press Start 2P';
      font-size: 16px;
      background: #000;
      color: #0f0;
      border: none;
      outline: none;
      appearance: none;
    }

    select option {
      font-family: 'Press Start 2P';
      background: #000;
      color: #0f0;
    }

    #player-answer,
    #guess {
      font-family: 'Press Start 2P';
      font-size: 20px;
      padding: 10px;
      width: 200px;
      text-align: center;
      border: 4px solid #fff;
      background: #000;
      color: #0f0;
    }

    #submit,
    #set-answer-btn,
    .dummy-btn {
      font-family: 'Press Start 2P';
      font-size: 16px;
      padding: 10px 20px;
      background: #222;
      color: #fff;
      border: 4px solid #fff;
      cursor: pointer;
      margin-bottom: 10px;
    }

    #submit:active,
    #set-answer-btn:active,
    .dummy-btn:active {
      background: #444;
    }

    .dummy-msg,
    #setup-msg {
      height: 20px;
      font-size: 12px;
      margin-top: 5px;
    }

    /* 中段：左側ゲーム画面 + 右側テンキー */
    .main-row {
      display: flex;
      justify-content: space-between;
      gap: 20px;
      margin-top: 30px;
    }

    .left-area {
      width: 70%;
    }

    .right-area {
      width: 180px;
      border: 4px solid #fff;
      background: #000;
      padding: 10px;
    }

    .keypad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }

    .keypad button {
      font-family: 'Press Start 2P';
      font-size: 14px;
      padding: 12px 0;
      background: #000;
      color: #0f0;
      border: 4px solid #fff;
      cursor: pointer;
    }

    .keypad button:active {
      background: #333;
    }

    #time-bar {
      width: 300px;
      height: 20px;
      border: 4px solid #fff;
      background: #222;
      margin: 10px auto;
    }

    #time-fill {
      height: 100%;
      background: #f00;
      width: 100%;
    }

    #result {
      font-size: 20px;
      margin-top: 20px;
    }

    /* YOU / CPU ログ横並び */
    #battle-area {
      display: flex;
      justify-content: space-between;
      gap: 20px;
      margin-top: 20px;
    }

    .panel {
      width: 48%;
      padding: 10px;
      border: 4px solid #fff;
      background: #000;
    }

    .panel h2 {
      font-size: 16px;
      margin-bottom: 10px;
    }

    .log-box {
      height: 250px;
      overflow-y: auto;
      background: #111;
      border: 4px solid #fff;
      padding: 10px;
      text-align: left;
      color: #0f0;
      font-size: 14px;
    }

    .log-box p {
      background: #000;
      padding: 8px;
      border-left: 6px solid #0f0;
      margin-bottom: 8px;
    }
  </style>
</head>

<body>
  <div id="container">
    <h1>HIT & BLOW</h1>

    <!-- 上段：CPU LEVEL & YOUR NUMBER -->
    <div class="setup-row">
      <div class="setup-box">
        <h2>CPU LEVEL</h2>
        <div class="fake-input">
          <select id="difficulty">
            <option value="easy">EASY</option>
            <option value="normal">NORMAL</option>
            <option value="hard">HARD</option>
          </select>
        </div>
        <button class="dummy-btn" disabled>OK</button>
        <p class="dummy-msg"></p>
      </div>

      <div class="setup-box">
        <h2>YOUR NUMBER</h2>
        <input type="text" id="player-answer" maxlength="4" placeholder="1234">
        <button id="set-answer-btn">OK</button>
        <p id="setup-msg"></p>
      </div>
    </div>

    <!-- 中段：左側ゲーム画面 + 右側テンキー -->
    <div class="main-row">
      <div class="left-area">
        <input type="text" id="guess" maxlength="4" placeholder="1234" disabled>
        <button id="submit" onclick>JUDGE</button>

        <p id="timer"></p>
        <div id="time-bar"><div id="time-fill"></div></div>

        <p id="result"></p>

        <div id="battle-area">
          <div class="panel">
            <h2>YOU</h2>
            <div id="player-log" class="log-box"></div>
          </div>

          <div class="panel">
            <h2>CPU</h2>
            <div id="cpu-log" class="log-box"></div>
          </div>
        </div>
      </div>

      <div class="right-area">
        <div class="keypad">
          <button>1</button><button>2</button><button>3</button>
          <button>4</button><button>5</button><button>6</button>
          <button>7</button><button>8</button><button>9</button>
          <button>DEL</button><button>0</button><button>OK</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const seInput = new Audio("sounds/click.wav");
    const seHit = new Audio("sounds/click.wav");
    const seBlow = new Audio("sounds/click.wav");
    const seError = new Audio("sounds/click.wav");
    const seClear = new Audio("sounds/click.wav");
    const playerAnswerInput = document.getElementById("player-answer");
    const setAnswerBtn = document.getElementById("set-answer-btn");
    const setupMsg = document.getElementById("setup-msg");
    const guessInput = document.getElementById("guess");
    const submit = document.getElementById("submit");
    const result = document.getElementById("result");
    const playerLog = document.getElementById("player-log");
    const cpuLog = document.getElementById("cpu-log");
    const timerEl = document.getElementById("timer");
    const timeFill = document.getElementById("time-fill");

    function generateAnswer() {
      const digits = [];
      while (digits.length < 4) {
        const n = Math.floor(Math.random() * 10);
        if (!digits.includes(n)) digits.push(n);
      }
      return digits.join('');
    }

    function generateAllCandidates() {
      const list = [];
      for (let a = 0; a < 10; a++)
      for (let b = 0; b < 10; b++)
      for (let c = 0; c < 10; c++)
      for (let d = 0; d < 10; d++) {
        if (new Set([a,b,c,d]).size === 4)
          list.push(`${a}${b}${c}${d}`);
      }
      return list;
    }

    function chooseBestGuess(candidates) {
      let bestGuess = candidates[0];
      let bestScore = Infinity;

      for (let guess of candidates) {
        let scoreMap = {};

        for (let target of candidates) {
          let h = 0, b = 0;
          for (let i = 0; i < 4; i++) {
            if (guess[i] === target[i]) h++;
            else if (target.includes(guess[i])) b++;
          }
          const key = `${h}-${b}`;
          scoreMap[key] = (scoreMap[key] || 0) + 1;
        }

        const worst = Math.max(...Object.values(scoreMap));
        if (worst < bestScore) {
          bestScore = worst;
          bestGuess = guess;
        }
      }
      return bestGuess;
    }

    let timer = null;
    let timeLeft = 30;

    function startTimer() {
      timeLeft = 30;
      timerEl.textContent = `TIME: ${timeLeft}`;
      timeFill.style.width = "100%";

      timer = setInterval(() => {
        timeLeft--;
        timerEl.textContent = `TIME: ${timeLeft}`;
        timeFill.style.width = (timeLeft / 30 * 100) + "%";

        if (timeLeft <= 0) {
          clearInterval(timer);
          timerEl.textContent = "TIME UP!";
          timeFill.style.width = "0%";
          result.textContent = "CPU WIN";
          submit.disabled = true;
        }
      }, 1000);
    }

    function stopTimer() {
      clearInterval(timer);
      timerEl.textContent = "";
      timeFill.style.width = "0%";
    }

    let difficulty = "easy";
    let playerAnswer = null;
    const cpuAnswer = generateAnswer();
    let cpuCandidates = generateAllCandidates();
    let turn = "player";

    document.getElementById("difficulty").addEventListener("change", e => {
      difficulty = e.target.value;
    });

    setAnswerBtn.addEventListener("click", () => {
      const val = playerAnswerInput.value.trim();

      if (!/^\d{4}$/.test(val)) {
        setupMsg.textContent = "4桁で入力";
        return;
      }
      if (new Set(val).size !== 4) {
        setupMsg.textContent = "重複NG";
        return;
      }

      playerAnswer = val;
      setupMsg.textContent = "SET OK";
      seClear.play(click.wav); 

      playerAnswerInput.disabled = true;
      setAnswerBtn.disabled = true;
      guessInput.disabled = false;
      submit.disabled = false;
    });

    submit.addEventListener("click", () => {
      if (turn !== "player") return;

      const guess = guessInput.value.trim();
      if (!/^\d{4}$/.test(guess)) return;
      if (new Set(guess).size !== 4) return;

      stopTimer();

      let hit = 0, blow = 0;
      for (let i = 0; i < 4; i++) {
        if (guess[i] === cpuAnswer[i]) hit++;
        else if (cpuAnswer.includes(guess[i])) blow++;
      }

      const pLine = document.createElement("p");
      pLine.textContent = `${guess} → ${hit}H ${blow}B`;
      playerLog.prepend(pLine);

      if (hit === 4) {
        result.textContent = "YOU WIN!";
        submit.disabled = true;
        return;
      }

      turn = "cpu";
      setTimeout(cpuTurn, 1000);
    });

    function cpuTurn() {
      let guess;

      if (difficulty === "easy") {
        guess = generateAnswer();
      } else if (difficulty === "normal") {
        guess = cpuCandidates[Math.floor(Math.random() * cpuCandidates.length)];
      } else {
        guess = chooseBestGuess(cpuCandidates);
      }

      let hit = 0, blow = 0;
      for (let i = 0; i < 4; i++) {
        if (guess[i] === playerAnswer[i]) hit++;
        else if (playerAnswer.includes(guess[i])) blow++;
      }

      const cLine = document.createElement("p");
      cLine.textContent = `${guess} → ${hit}H ${blow}B`;
      cpuLog.prepend(cLine);

      if (hit === 4) {
        result.textContent = "CPU WIN";
        submit.disabled = true;
        return;
      }

      if (difficulty !== "easy") {
        cpuCandidates = cpuCandidates.filter(c => {
          let h = 0, b = 0;
          for (let i = 0; i < 4; i++) {
            if (c[i] === guess[i]) h++;
            else if (guess.includes(c[i])) b++;
          }
          return h === hit && b === blow;
        });
      }

      turn = "player";
      if (difficulty === "hard") startTimer();
    }

    /* ▼ テンキー入力（YOUR NUMBER と GUESS 両対応） */
    document.querySelectorAll(".keypad button").forEach(btn => {
      btn.addEventListener("click", () => {
        const val = btn.textContent;

        // YOUR NUMBER 未確定 → YOUR NUMBER に入力
        // 確定後 → GUESS に入力
        const target = playerAnswer === null ? playerAnswerInput : guessInput;

        if (val === "DEL") {
          target.value = target.value.slice(0, -1);
          return;
        }

        if (val === "OK") {
          if (playerAnswer === null) {
            setAnswerBtn.click();
          } else {
            submit.click();
          }
          return;
        }

        if (target.value.length < 4) {
          target.value += val;
        }
      });
    });
  </script>
</body>
</html>